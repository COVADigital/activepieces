---
title: 'Create Trigger'
icon: 'circle-5'
description: ''
---

We will now implement a trigger for the `clickup` piece, which can take one of the following trigger types:

- `Polling`: Periodically call endpoints to check for changes.
- `Webhooks`: Listen to user events through a single URL.
- `App Webhooks (Subscriptions)`: Use a developer app (using OAuth2) to receive all authorized user events at a single URL (Not Supported).

Given that ClickUp's API documentation offers [webhooks](https://clickup.com/api/developer-portal/webhooks/) for specific events, we'll leverage these to establish the trigger.

We'll set up a trigger to activate for every new space generated within a Workspace, utilizing [space webhooks](https://clickup.com/api/developer-portal/webhooks/#space-webhooks).

### Trigger Defination

To create trigger run the following command,

```bash
npm run cli triggers create
```

1. `Piece Folder Name`: This is the name associated with the folder where the trigger resides. It helps organize and categorize triggers within the piece.
2. `Trigger Display Name`: The name users see in the interface, conveying the trigger's purpose clearly.
3. `Trigger Description`: A brief, informative text in the UI, guiding users about the trigger's function and purpose.
4. `Trigger Technique`: Specifies the trigger type - either polling or webhook.

**Example:**

```bash
npm run cli triggers create

? Enter the piece folder name : clickup
? Enter the trigger display name : new space created
? Enter the trigger description : triggers when a new space is created.
? Select the trigger technique: webhook
```

This will create new typescript file at `packages/pieces/community/clickup/src/lib/triggers`,the `new-space-created.ts` file should contain following code.

```typescript
import { createTrigger, TriggerStrategy } from '@activepieces/pieces-framework';
export const newSpaceCreated = createTrigger({
  // auth: check https://www.activepieces.com/docs/developers/piece-reference/authentication,
  name: 'newSpaceCreated',
  displayName: 'new space created',
  description: 'triggers when a new space is created.',
  props: {},
  sampleData: {},
  type: TriggerStrategy.WEBHOOK,
  async onEnable(context) {
    // implement webhook creation logic
  },
  async onDisable(context) {
    // implement webhook deletion logic
  },
  async run(context) {
    return [context.payload.body];
  },
});
```

Here's the brekdown of the key components of `createTrigger` function:

- `name`: This property serves as a unique identifier for the trigger within the piece.
- `displayName`:The human-readable name displayed in the user interface (UI) for this trigger.
- `description`:A brief description providing information about the purpose of the trigger.
- `auth`: The auth property can be utilized to specify authentication requirements for the piece. Authentication is crucial for secure interactions with external services, as detailed in the [authentication documentation](https://www.activepieces.com/docs/developers/piece-reference/authentication).
- `props` - This property defines the set of properties required for the trigger. Currently set as an empty object, it can be populated with specific properties as detailed in the [props documentation](https://www.activepieces.com/docs/developers/piece-reference/properties).
- `onEnable`- Function to perform an HTTP request to register the webhook in a third-party app, and store the webhook Id in the `store`.
- `onDisable` - Function to fetch the webhook ID from the `context.store` and delete the webhook on the third-party app.
- `run` - Function responsible for trigger implementation, invoked each time data is received through the webhook.

### Trigger Authentication

Reuse ClickUp piece authentication for the trigger.

```typescript
//..
import { clickupAuth } from '../../..';

export const newSpaceCreated = createTrigger({
  auth: clickupAuth,
  //...
});
```

### Trigger Props

To define the required properties for the `newSpaceCreated` trigger, we can consult the ClickUp API documentation, specifically the [endpoint](https://clickup.com/api/clickupreference/operation/CreateWebhook/) responsible for creating a webhook.

As outlined in the documentation, the endpoint for creating a webhook in ClickUp requires three mandatory properties:

1. `team_id`: Identifies the team where the space will be created.
2. `endpoint`: The URL used to receive event data from ClickUp, and we can use `context.webhookUrl` for this purpose.
3. `events`: An array of events that the webhook should listen to. In this case, we'll use will use **spaceCreated** event from [space webhooks](https://clickup.com/api/developer-portal/webhooks/#space-webhooks).

The only required property from the user is `team_id`, and we can use the **Number** type for this field.

```typescript
import {
  createTrigger,
  TriggerStrategy,
  Property,
} from '@activepieces/pieces-framework';

export const newSpaceCreated = createTrigger({
  //..
  props: {
    team_id: Property.Number({
      displayName: 'Team ID',
      required: true,
    }),
  },
  //..
});
```

### onEnable Function

Now we need to implement HTTP request that generate Clickup webhook using `onEnable` function.

```typescript
//..
import {
  HttpClient,
  HttpRequest,
  HttpMethod,
} from '@activepieces/pieces-common';

export const newSpaceCreated = createTrigger({
  //..
  async onEnable(context) {
    const { team_id } = context.propsValue;
    const request: HttpRequest = {
      method: HttpMethod.POST,
      url: `https://api.clickup.com/api/v2/team/${team_id}/webhook`,
      headers: {
        Authorization: context.auth as string,
      },
      body: {
        endpoint: context.webhookUrl,
        events: ['spaceCreated'],
      },
    };

    const res = await httpClient.sendRequest(request);

    // store response data inside context.store

    await contex.store('new_space_created_trigger', res.body);
  },
});
```

Upon successful webhook creation, details including the **id** will be received from ClickUp. We store this information in `context.store` for future use, particularly when deleting the webhook in the `onDisable` function.

### onDisable Function

To delete a ClickUp webhook, we implement an HTTP request within the `onDisable` function. The necessary **webhook_id** is retrieved from the stored data obtained during the webhook enable step.

```typescript
import {
  HttpClient,
  HttpRequest,
  HttpMethod,
} from '@activepieces/pieces-common';

export const newSpaceCreated = createTrigger({
  //..
  async onDisable(context) {
    const webhook = await context.store.get(`new_space_created_trigger`);
    if (webhook != null) {
      const request: HttpRequest = {
        method: HttpMethod.DELETE,
        url: `https://api.clickup.com/api/v2/webhook/${webhook.id}`,
        headers: {
          Authorization: context.auth as string,
        },
      };
      const response = await httpClient.sendRequest(request);
    }
  },
});
```

### run Function

The HTTP body for the webhook event can be accessed through `context.payload.body`. If necessary, you can modify the body; otherwise, return an array containing a single item, `context.payload.body`.

<Tip>
  Itâ€™s important to note that the run method returns an array. The reason for
  this is that a single polling can contain multiple triggers, so each item in
  the array will trigger the flow to run.
</Tip>

```typescript
//..
export const newSpaceCreated = createTrigger({
  //..
  async run(context) {
    return [context.payload.body];
  },
});
```

### Expose The Definition

To make the trigger readable by Activepieces, add it to the array of triggers in the piece definition.

Let's add `newSpaceCreated` trigger by modifing `src/index.ts` file.

```typescript
import { createPiece, PieceAuth } from '@activepieces/pieces-framework';
import { createTaskTag } from './lib/actions/create-task-tag.ts';

// Don't forget to add the following import.
import { newSpaceCreated } from './lib/triggers/new-space-created.ts';

export const clickup = createPiece({
  displayName: 'Clickup',
  auth: clickupAuth,
  minimumSupportedRelease: '0.9.0',
  logoUrl: 'https://cdn.activepieces.com/pieces/clickup.png',
  authors: [],
  actions: [createTaskTag],
  // Add the trigger here.
  triggers: [newSpaceCreated], // <--------
});
```

### Testing

<Warning>
To make your webhook accessible from the internet, you need to configure the backend URL. Follow these steps:

1. Install ngrok.
2. Run the command `ngrok http 3000`.
3. Replace the `AP_WEBHOOK_URL` environment variable in `packages/backend/.env` with the ngrok URL.

Once you have completed these configurations, you are good to go!

</Warning>
